require('dotenv').config();
const { Telegraf } = require('telegraf');

const token = process.env.BOT_TOKEN;
const webAppUrl = process.env.WEBAPP_URL;
const bot = new Telegraf(token);

bot.telegram.setMyCommands([
    { command: 'start', description: 'Ð¡Ñ‚Ð°Ñ€Ñ‚' },
    { command: 'help', description: 'ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ' },
    { command: 'form', description: 'Ð—Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ Ñ„Ð¾Ñ€Ð¼Ñƒ' }
]);

bot.command('start', async (ctx) => {
    await ctx.reply('Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ! Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ:', {
        reply_markup: {
            inline_keyboard: [
                [{ text: 'ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð²ÐµÐ±-Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ', web_app: { url: webAppUrl } }],
                [{ text: 'ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ', callback_data: 'help' }]
            ]
        }
    });
});

bot.command('help', async (ctx) => {
    await ctx.reply(
        'Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:\n' +
        '/start - ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ Ñ Ð±Ð¾Ñ‚Ð¾Ð¼\n' +
        '/help - ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÑÐ¿Ñ€Ð°Ð²ÐºÑƒ\n' +
        '/form - Ð—Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ Ñ„Ð¾Ñ€Ð¼Ñƒ\n' +
        '\nÐ¢Ð°ÐºÐ¶Ðµ Ð²Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ:\n' +
        '- ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ ÑÑ‚Ð¸ÐºÐµÑ€\n' +
        '- ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ñ„Ð¾Ñ‚Ð¾\n' +
        '- ÐŸÐ¾Ð´ÐµÐ»Ð¸Ñ‚ÑŒÑÑ Ð»Ð¾ÐºÐ°Ñ†Ð¸ÐµÐ¹'
    );
});

bot.on('web_app_data', async (ctx) => {
    const data = ctx.webAppData.data;
    try {
        const jsonData = JSON.parse(data);
        await ctx.reply(`ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð· Ñ„Ð¾Ñ€Ð¼Ñ‹:\n${JSON.stringify(jsonData, null, 2)}`);
    } catch (e) {
        await ctx.reply('ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ Ð´Ð°Ð½Ð½Ñ‹Ñ…');
    }
});

bot.on('photo', async (ctx) => {
    try {
        await ctx.reply('Ð¤Ð¾Ñ‚Ð¾ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¾! Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾ Ð·Ð° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÑƒ.');
    } catch (e) {
        await ctx.reply('ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ Ñ„Ð¾Ñ‚Ð¾');
    }
});

bot.on('location', async (ctx) => {
    try {
        const { latitude, longitude } = ctx.message.location;
        await ctx.reply(`ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ñ‹ ÐºÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð°Ñ‚Ñ‹:\nÐ¨Ð¸Ñ€Ð¾Ñ‚Ð°: ${latitude}\nÐ”Ð¾Ð»Ð³Ð¾Ñ‚Ð°: ${longitude}`);
    } catch (e) {
        await ctx.reply('ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ Ð»Ð¾ÐºÐ°Ñ†Ð¸Ð¸');
    }
});

bot.on('callback_query', async (ctx) => {
    const action = ctx.callbackQuery.data;

    if (action === 'help') {
        await ctx.answerCbQuery();
        await ctx.reply(
            'Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:\n' +
            '/start - ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ Ñ Ð±Ð¾Ñ‚Ð¾Ð¼\n' +
            '/help - ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÑÐ¿Ñ€Ð°Ð²ÐºÑƒ\n' +
            '/form - Ð—Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ Ñ„Ð¾Ñ€Ð¼Ñƒ'
        );
    }
});

bot.on('sticker', async (ctx) => {
    await ctx.reply('ÐšÐ»Ð°ÑÑÐ½Ñ‹Ð¹ ÑÑ‚Ð¸ÐºÐµÑ€! ðŸ‘');
});

bot.on('text', async (ctx) => {
    await ctx.reply('Ð¯ Ð¿Ð¾Ð½Ð¸Ð¼Ð°ÑŽ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð¸ ÑÐ¿ÐµÑ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ñ‚Ð¸Ð¿Ñ‹ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹');
});

bot.launch();

process.once('SIGINT', () => bot.stop('SIGINT'));
process.once('SIGTERM', () => bot.stop('SIGTERM'));
